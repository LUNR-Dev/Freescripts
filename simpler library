
-- ESP Library with Color Customization + 3D Box ESP + Glow ESP + Tracers

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")

local ESP = {}

-- SETTINGS
getgenv().ESPSettings = getgenv().ESPSettings or {}
ESPSettings.boxESP = ESPSettings.boxESP or false
ESPSettings.box3dESP = ESPSettings.box3dESP or false
ESPSettings.nameESP = ESPSettings.nameESP or false
ESPSettings.glowESP = ESPSettings.glowESP or false
ESPSettings.tracerESP = ESPSettings.tracerESP or false
ESPSettings.teamCheck = ESPSettings.teamCheck or false
ESPSettings.masterColor = ESPSettings.masterColor or false
ESPSettings.boxColor = ESPSettings.boxColor or Color3.fromRGB(255,0,0)
ESPSettings.nameColor = ESPSettings.nameColor or Color3.fromRGB(255,255,255)
ESPSettings.mainColor = ESPSettings.mainColor or Color3.fromRGB(0,255,0)
ESPSettings.glowColor = ESPSettings.glowColor or Color3.fromRGB(0,255,255)
ESPSettings.tracerColor = ESPSettings.tracerColor or Color3.fromRGB(255,255,0)

-- SAFETY WRAPPER
local function SafeColor(c)
    return typeof(c) == "Color3" and c or Color3.fromRGB(255,255,255)
end

-- DRAWING TABLES
local BoxESPBoxes, NameESPLabels, Box3DLines, GlowESP, Tracers = {}, {}, {}, {}, {}

------------------------------------------
-- 3D BOX FUNCTIONS
------------------------------------------
local function Create3DBox(character)
    if Box3DLines[character] then return end
    Box3DLines[character] = {}
    for i = 1, 12 do
        local line = Drawing.new("Line")
        line.Visible = false
        line.Thickness = 2
        line.Color = SafeColor(ESPSettings.boxColor)
        Box3DLines[character][i] = line
    end
end

local function Remove3DBox(character)
    if Box3DLines[character] then
        for _, l in ipairs(Box3DLines[character]) do l:Remove() end
        Box3DLines[character] = nil
    end
end

local function Update3DBox(character, hrp, camera)
    if not Box3DLines[character] then return end
    local size = Vector3.new(2, 3, 1.5)
    local cf = hrp.CFrame
    local corners = {
        cf * Vector3.new(-size.X, -size.Y, -size.Z),
        cf * Vector3.new(size.X, -size.Y, -size.Z),
        cf * Vector3.new(size.X, size.Y, -size.Z),
        cf * Vector3.new(-size.X, size.Y, -size.Z),
        cf * Vector3.new(-size.X, -size.Y, size.Z),
        cf * Vector3.new(size.X, -size.Y, size.Z),
        cf * Vector3.new(size.X, size.Y, size.Z),
        cf * Vector3.new(-size.X, size.Y, size.Z),
    }
    local screen = {}
    for i = 1, 8 do
        local p, vis = camera:WorldToViewportPoint(corners[i])
        if not vis then
            for _, l in ipairs(Box3DLines[character]) do l.Visible = false end
            return
        end
        screen[i] = Vector2.new(p.X, p.Y)
    end
    local edges = {
        {1,2},{2,3},{3,4},{4,1},
        {5,6},{6,7},{7,8},{8,5},
        {1,5},{2,6},{3,7},{4,8},
    }
    local color = SafeColor(ESPSettings.masterColor and ESPSettings.mainColor or ESPSettings.boxColor)
    for i, e in ipairs(edges) do
        local line = Box3DLines[character][i]
        line.Visible = ESPSettings.box3dESP
        line.Color = color
        line.From = screen[e[1]]
        line.To = screen[e[2]]
    end
end

------------------------------------------
-- 2D BOX + NAME FUNCTIONS
------------------------------------------
local function CreateBox(character)
    if not character:FindFirstChild("HumanoidRootPart") then return end
    local box = Drawing.new("Square")
    box.Visible = false
    box.Thickness = 2
    box.Color = SafeColor(ESPSettings.boxColor)
    box.Filled = false
    box.Transparency = 1
    BoxESPBoxes[character] = box
end

local function RemoveBox(character)
    if BoxESPBoxes[character] then BoxESPBoxes[character]:Remove(); BoxESPBoxes[character] = nil end
end

local function CreateName(character)
    if not character:FindFirstChild("Head") then return end
    local label = Drawing.new("Text")
    label.Visible = false
    label.Color = SafeColor(ESPSettings.nameColor)
    label.Size = 16
    label.Center = true
    label.Outline = true
    label.Text = character.Name
    NameESPLabels[character] = label
end

local function RemoveName(character)
    if NameESPLabels[character] then NameESPLabels[character]:Remove(); NameESPLabels[character] = nil end
end

------------------------------------------
-- GLOW FUNCTIONS
------------------------------------------
local function CreateGlow(character)
    if not character:FindFirstChild("HumanoidRootPart") then return end
    local glow = Drawing.new("Circle")
    glow.Visible = false
    glow.Thickness = 4
    glow.NumSides = 30
    glow.Radius = 60
    glow.Color = SafeColor(ESPSettings.glowColor)
    glow.Filled = false
    glow.Transparency = 0.8
    GlowESP[character] = glow
end

local function RemoveGlow(character)
    if GlowESP[character] then GlowESP[character]:Remove(); GlowESP[character] = nil end
end

local function UpdateGlow(character, hrp, camera)
    if not GlowESP[character] then return end
    local pos, onScreen = camera:WorldToViewportPoint(hrp.Position)
    if onScreen then
        local glow = GlowESP[character]
        glow.Visible = ESPSettings.glowESP
        glow.Position = Vector2.new(pos.X, pos.Y)
        glow.Color = SafeColor(ESPSettings.masterColor and ESPSettings.mainColor or ESPSettings.glowColor)
    else
        GlowESP[character].Visible = false
    end
end

------------------------------------------
-- TRACER FUNCTIONS
------------------------------------------
local function CreateTracer(character)
    if Tracers[character] then return end
    local line = Drawing.new("Line")
    line.Visible = false
    line.Thickness = 1.5
    line.Color = SafeColor(ESPSettings.tracerColor)
    Tracers[character] = line
end

local function RemoveTracer(character)
    if Tracers[character] then Tracers[character]:Remove(); Tracers[character] = nil end
end

local function UpdateTracer(character, hrp, camera)
    if not Tracers[character] then return end
    local pos, onScreen = camera:WorldToViewportPoint(hrp.Position)
    if onScreen then
        local line = Tracers[character]
        line.Visible = ESPSettings.tracerESP
        line.Color = SafeColor(ESPSettings.masterColor and ESPSettings.mainColor or ESPSettings.tracerColor)
        local screenSize = camera.ViewportSize
        line.From = Vector2.new(screenSize.X / 2, screenSize.Y)
        line.To = Vector2.new(pos.X, pos.Y)
    else
        Tracers[character].Visible = false
    end
end

------------------------------------------
-- TEAM CHECK
------------------------------------------
local function IsEnemy(player)
    if not ESPSettings.teamCheck then return true end
    return player.Team ~= Players.LocalPlayer.Team
end

------------------------------------------
-- PLAYER EVENTS
------------------------------------------
local function OnCharacterAdded(character)
    CreateBox(character)
    CreateName(character)
    Create3DBox(character)
    CreateGlow(character)
    CreateTracer(character)
    local hum = character:FindFirstChild("Humanoid")
    if hum then
        hum.Died:Connect(function()
            RemoveBox(character)
            RemoveName(character)
            Remove3DBox(character)
            RemoveGlow(character)
            RemoveTracer(character)
        end)
    end
end

local function OnPlayerAdded(player)
    player.CharacterAdded:Connect(OnCharacterAdded)
    if player.Character then OnCharacterAdded(player.Character) end
end

local function OnPlayerRemoving(player)
    if player.Character then
        RemoveBox(player.Character)
        RemoveName(player.Character)
        Remove3DBox(player.Character)
        RemoveGlow(player.Character)
        RemoveTracer(player.Character)
    end
end

for _, p in ipairs(Players:GetPlayers()) do OnPlayerAdded(p) end
Players.PlayerAdded:Connect(OnPlayerAdded)
Players.PlayerRemoving:Connect(OnPlayerRemoving)

------------------------------------------
-- RENDER LOOP
------------------------------------------


------------------------------------------
-- RENDER LOOP
------------------------------------------
RunService.RenderStepped:Connect(function()
    local camera = Workspace.CurrentCamera

    -- 2D BOX
    for character, box in pairs(BoxESPBoxes) do
        local player = Players:GetPlayerFromCharacter(character)
        if player and ESPSettings.boxESP and IsEnemy(player) then
            local hrp = character:FindFirstChild("HumanoidRootPart")
            if hrp then
                local pos, onScreen = camera:WorldToViewportPoint(hrp.Position)
                if onScreen then
                    local scale = 1 / pos.Z * 120
                    local width, height = 35 * scale, 50 * scale
                    box.Visible = true
                    box.Position = Vector2.new(pos.X - width/2, pos.Y - height/2)
                    box.Size = Vector2.new(width, height)
                    box.Color = SafeColor(ESPSettings.masterColor and ESPSettings.mainColor or ESPSettings.boxColor)
                else
                    box.Visible = false
                end
            end
        else
            box.Visible = false
        end
    end

    -- NAME ESP
    for character, label in pairs(NameESPLabels) do
        local player = Players:GetPlayerFromCharacter(character)
        if player and ESPSettings.nameESP and IsEnemy(player) then
            local head = character:FindFirstChild("Head")
            if head then
                local pos, onScreen = camera:WorldToViewportPoint(head.Position + Vector3.new(0, 2, 0))
                if onScreen then
                    label.Visible = true
                    label.Position = Vector2.new(pos.X, pos.Y)
                    label.Color = SafeColor(ESPSettings.masterColor and ESPSettings.mainColor or ESPSettings.nameColor)
                else
                    label.Visible = false
                end
            end
        else
            label.Visible = false
        end
    end

    -- 3D BOX
    for character, _ in pairs(Box3DLines) do
        local player = Players:GetPlayerFromCharacter(character)
        if player and ESPSettings.box3dESP and IsEnemy(player) then
            local hrp = character:FindFirstChild("HumanoidRootPart")
            if hrp then
                Update3DBox(character, hrp, camera)
            end
        else
            for _, l in ipairs(Box3DLines[character] or {}) do
                l.Visible = false
            end
        end
    end

    -- GLOW ESP
    for character, glow in pairs(GlowESP) do
        local player = Players:GetPlayerFromCharacter(character)
        if player and ESPSettings.glowESP and IsEnemy(player) then
            local hrp = character:FindFirstChild("HumanoidRootPart")
            if hrp then
                UpdateGlow(character, hrp, camera)
            else
                glow.Visible = false
            end
        else
            glow.Visible = false
        end
    end

    -- TRACERS
    for character, line in pairs(Tracers) do
        local player = Players:GetPlayerFromCharacter(character)
        if player and ESPSettings.tracerESP and IsEnemy(player) then
            local hrp = character:FindFirstChild("HumanoidRootPart")
            if hrp then
                UpdateTracer(character, hrp, camera)
            end
        else
            line.Visible = false
        end
    end
end)

------------------------------------------
-- PUBLIC FUNCTIONS
------------------------------------------
function ESP:SetBoxESP(b) ESPSettings.boxESP = b end
function ESP:Set3DBoxESP(b) ESPSettings.box3dESP = b end
function ESP:SetNameESP(b) ESPSettings.nameESP = b end
function ESP:SetGlowESP(b) ESPSettings.glowESP = b end
function ESP:SetTracerESP(b) ESPSettings.tracerESP = b end
function ESP:SetTeamCheck(b) ESPSettings.teamCheck = b end
function ESP:SetMasterColor(b) ESPSettings.masterColor = b end
function ESP:SetBoxColor(c) ESPSettings.boxColor = SafeColor(c) end
function ESP:SetNameColor(c) ESPSettings.nameColor = SafeColor(c) end
function ESP:SetMainColor(c) ESPSettings.mainColor = SafeColor(c) end
function ESP:SetGlowColor(c) ESPSettings.glowColor = SafeColor(c) end
function ESP:SetTracerColor(c) ESPSettings.tracerColor = SafeColor(c) end

function ESP:ToggleBoxESP() ESPSettings.boxESP = not ESPSettings.boxESP end
function ESP:Toggle3DBoxESP() ESPSettings.box3dESP = not ESPSettings.box3dESP end
function ESP:ToggleNameESP() ESPSettings.nameESP = not ESPSettings.nameESP end
function ESP:ToggleGlowESP() ESPSettings.glowESP = not ESPSettings.glowESP end
function ESP:ToggleTracerESP() ESPSettings.tracerESP = not ESPSettings.tracerESP end
function ESP:ToggleTeamCheck() ESPSettings.teamCheck = not ESPSettings.teamCheck end
function ESP:ToggleMasterColor() ESPSettings.masterColor = not ESPSettings.masterColor end

return ESP
