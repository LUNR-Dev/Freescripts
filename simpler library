-- ESP Library with Color Customization
-- Usage:
-- local lib = loadstring(game:HttpGet("YOUR_URL_HERE"))()
-- lib.boxESP = true
-- lib.nameESP = true
-- lib.teamCheck = true
-- lib.masterColor = true
-- lib.boxColor = Color3.fromRGB(255,0,0)
-- lib.nameColor = Color3.fromRGB(255,255,255)
-- lib.mainColor = Color3.fromRGB(0,255,0)

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")

local ESP = {}

-- getgenv settings
getgenv().ESPSettings = getgenv().ESPSettings or {}
ESPSettings.boxESP = ESPSettings.boxESP or false
ESPSettings.nameESP = ESPSettings.nameESP or false
ESPSettings.teamCheck = ESPSettings.teamCheck or false
ESPSettings.masterColor = ESPSettings.masterColor or false
ESPSettings.boxColor = ESPSettings.boxColor or Color3.fromRGB(255,0,0)
ESPSettings.nameColor = ESPSettings.nameColor or Color3.fromRGB(255,255,255)
ESPSettings.mainColor = ESPSettings.mainColor or Color3.fromRGB(0,255,0)

-- Tables for ESP drawings
local BoxESPBoxes = {}
local NameESPLabels = {}

-- --- Helper Functions ---
local function CreateBox(character)
    if not character or not character:FindFirstChild("HumanoidRootPart") then return end
    local box = Drawing.new("Square")
    box.Visible = false
    box.Thickness = 2
    box.Color = ESPSettings.boxColor
    box.Filled = false
    box.Transparency = 1
    BoxESPBoxes[character] = box
end

local function RemoveBox(character)
    if BoxESPBoxes[character] then
        BoxESPBoxes[character]:Remove()
        BoxESPBoxes[character] = nil
    end
end

local function CreateName(character)
    if not character or not character:FindFirstChild("Head") then return end
    local label = Drawing.new("Text")
    label.Visible = false
    label.Color = ESPSettings.nameColor
    label.Size = 16
    label.Center = true
    label.Outline = true
    label.Text = character.Name
    NameESPLabels[character] = label
end

local function RemoveName(character)
    if NameESPLabels[character] then
        NameESPLabels[character]:Remove()
        NameESPLabels[character] = nil
    end
end

local function IsEnemy(player)
    if not ESPSettings.teamCheck then return true end
    local localPlayer = Players.LocalPlayer
    if not localPlayer then return true end
    if not player.Team or not localPlayer.Team then return true end
    return player.Team ~= localPlayer.Team
end

-- --- Player Events ---
local function OnCharacterAdded(character)
    CreateBox(character)
    CreateName(character)
    
    local humanoid = character:FindFirstChild("Humanoid")
    if humanoid then
        humanoid.Died:Connect(function()
            RemoveBox(character)
            RemoveName(character)
        end)
    end
end

local function OnPlayerAdded(player)
    player.CharacterAdded:Connect(OnCharacterAdded)
    if player.Character then
        OnCharacterAdded(player.Character)
    end
end

local function OnPlayerRemoving(player)
    if player.Character then
        RemoveBox(player.Character)
        RemoveName(player.Character)
    end
end

for _, player in pairs(Players:GetPlayers()) do
    OnPlayerAdded(player)
end
Players.PlayerAdded:Connect(OnPlayerAdded)
Players.PlayerRemoving:Connect(OnPlayerRemoving)

-- --- Render Loop ---
RunService.RenderStepped:Connect(function()
    local camera = Workspace.CurrentCamera
    for character, box in pairs(BoxESPBoxes) do
        local player = Players:GetPlayerFromCharacter(character)
        if player and ESPSettings.boxESP and IsEnemy(player) and character:FindFirstChild("HumanoidRootPart") then
            local hrp = character.HumanoidRootPart
            local pos, onScreen = camera:WorldToViewportPoint(hrp.Position)
            if onScreen then
                -- FOV-based scaling
                local scale = 1 / (pos.Z * math.tan(math.rad(camera.FieldOfView * 0.5)) * 2) * 1000
                local width, height = math.floor(4.5 * scale), math.floor(6 * scale)
                local x, y = math.floor(pos.X), math.floor(pos.Y)
                local xPosition, yPosition = math.floor(x - width * 0.5), math.floor((y - height * 0.5) + (0.5 * scale))

                box.Visible = true
                box.Position = Vector2.new(xPosition, yPosition)
                box.Size = Vector2.new(width, height)

                -- Color
                box.Color = ESPSettings.masterColor and ESPSettings.mainColor or ESPSettings.boxColor
            else
                box.Visible = false
            end
        else
            if box then box.Visible = false end
        end
    end

    for character, label in pairs(NameESPLabels) do
        local player = Players:GetPlayerFromCharacter(character)
        if player and ESPSettings.nameESP and IsEnemy(player) and character:FindFirstChild("Head") then
            local head = character.Head
            local pos, onScreen = camera:WorldToViewportPoint(head.Position + Vector3.new(0, 1.5, 0))
            if onScreen then
                label.Visible = true
                label.Position = Vector2.new(pos.X, pos.Y)
                label.Color = ESPSettings.masterColor and ESPSettings.mainColor or ESPSettings.nameColor
            else
                label.Visible = false
            end
        else
            if label then label.Visible = false end
        end
    end
end)

-- --- Library Functions ---
function ESP:SetBoxESP(bool) ESPSettings.boxESP = bool end
function ESP:SetNameESP(bool) ESPSettings.nameESP = bool end
function ESP:SetTeamCheck(bool) ESPSettings.teamCheck = bool end
function ESP:SetMasterColor(bool) ESPSettings.masterColor = bool end
function ESP:SetBoxColor(color) ESPSettings.boxColor = color end
function ESP:SetNameColor(color) ESPSettings.nameColor = color end
function ESP:SetMainColor(color) ESPSettings.mainColor = color end

function ESP:ToggleBoxESP() ESPSettings.boxESP = not ESPSettings.boxESP end
function ESP:ToggleNameESP() ESPSettings.nameESP = not ESPSettings.nameESP end
function ESP:ToggleTeamCheck() ESPSettings.teamCheck = not ESPSettings.teamCheck end
function ESP:ToggleMasterColor() ESPSettings.masterColor = not ESPSettings.masterColor end

return ESP
