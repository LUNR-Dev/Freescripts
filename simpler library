-- ESP Library with Distance-Based Scaling
-- Usage:
-- local lib = loadstring(game:HttpGet("YOUR_URL_HERE"))()
-- lib.boxESP = true
-- lib.nameESP = true

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")

-- Main library table
local ESP = {}

-- Setup getgenv variables
getgenv().ESPSettings = getgenv().ESPSettings or {}
ESPSettings.boxESP = ESPSettings.boxESP or false
ESPSettings.nameESP = ESPSettings.nameESP or false

-- Tables to store ESP drawings
local BoxESPBoxes = {}
local NameESPLabels = {}

-- --- Helper Functions --- --

-- Create Box ESP for a character
local function CreateBox(character)
    if not character or not character:FindFirstChild("HumanoidRootPart") then return end
    local box = Drawing.new("Square")
    box.Visible = false
    box.Thickness = 2
    box.Color = Color3.fromRGB(255, 0, 0)
    box.Filled = false
    box.Transparency = 1
    BoxESPBoxes[character] = box
end

-- Remove Box ESP
local function RemoveBox(character)
    if BoxESPBoxes[character] then
        BoxESPBoxes[character]:Remove()
        BoxESPBoxes[character] = nil
    end
end

-- Create Name ESP for a character
local function CreateName(character)
    if not character or not character:FindFirstChild("Head") then return end
    local nameLabel = Drawing.new("Text")
    nameLabel.Visible = false
    nameLabel.Color = Color3.fromRGB(255, 255, 255)
    nameLabel.Size = 16
    nameLabel.Center = true
    nameLabel.Outline = true
    nameLabel.Text = character.Name
    NameESPLabels[character] = nameLabel
end

-- Remove Name ESP
local function RemoveName(character)
    if NameESPLabels[character] then
        NameESPLabels[character]:Remove()
        NameESPLabels[character] = nil
    end
end

-- Handle character added
local function OnCharacterAdded(character)
    CreateBox(character)
    CreateName(character)
    
    local humanoid = character:FindFirstChild("Humanoid")
    if humanoid then
        humanoid.Died:Connect(function()
            RemoveBox(character)
            RemoveName(character)
        end)
    end
end

-- Handle player added
local function OnPlayerAdded(player)
    player.CharacterAdded:Connect(OnCharacterAdded)
    if player.Character then
        OnCharacterAdded(player.Character)
    end
end

-- Handle player leaving
local function OnPlayerRemoving(player)
    if player.Character then
        RemoveBox(player.Character)
        RemoveName(player.Character)
    end
end

-- Connect events for all players
for _, player in pairs(Players:GetPlayers()) do
    OnPlayerAdded(player)
end
Players.PlayerAdded:Connect(OnPlayerAdded)
Players.PlayerRemoving:Connect(OnPlayerRemoving)

-- --- Render Loop with Distance Scaling --- --
RunService.RenderStepped:Connect(function()
    local camera = Workspace.CurrentCamera
    local camPos = camera.CFrame.Position

    for character, box in pairs(BoxESPBoxes) do
        if ESPSettings.boxESP and character and character:FindFirstChild("HumanoidRootPart") then
            local hrp = character.HumanoidRootPart
            local head = character:FindFirstChild("Head")
            local torso = character:FindFirstChild("UpperTorso") or character:FindFirstChild("Torso")
            
            if head and torso then
                -- Top and bottom positions
                local topPos, topOnScreen = camera:WorldToViewportPoint(head.Position + Vector3.new(0, 0.5, 0))
                local bottomPos, bottomOnScreen = camera:WorldToViewportPoint(hrp.Position - Vector3.new(0, 0.5, 0))

                if topOnScreen and bottomOnScreen then
                    box.Visible = true

                    -- Distance scaling
                    local distance = (hrp.Position - camPos).Magnitude
                    local scale = math.clamp(500 / distance, 0.5, 5) -- closer = bigger, further = smaller

                    local width = (torso.Size.X + 1) * 20 * scale
                    local height = (bottomPos.Y - topPos.Y) * 1.1 * scale

                    box.Position = Vector2.new(topPos.X - width / 2, topPos.Y)
                    box.Size = Vector2.new(width, height)
                else
                    box.Visible = false
                end
            end
        else
            if box then box.Visible = false end
        end
    end

    -- Name ESP with distance scaling
    for character, label in pairs(NameESPLabels) do
        if ESPSettings.nameESP and character and character:FindFirstChild("Head") then
            local head = character.Head
            local pos, onScreen = camera:WorldToViewportPoint(head.Position + Vector3.new(0, 1.5, 0))

            if onScreen then
                label.Visible = true

                -- Distance scaling
                local distance = (head.Position - camPos).Magnitude
                local scale = math.clamp(500 / distance, 0.5, 5) -- same scale factor
                label.Size = 16 * scale

                label.Position = Vector2.new(pos.X, pos.Y)
            else
                label.Visible = false
            end
        else
            if label then label.Visible = false end
        end
    end
end)

-- --- Library Functions --- --

function ESP:SetBoxESP(bool)
    ESPSettings.boxESP = bool
end

function ESP:SetNameESP(bool)
    ESPSettings.nameESP = bool
end

function ESP:ToggleBoxESP()
    ESPSettings.boxESP = not ESPSettings.boxESP
end

function ESP:ToggleNameESP()
    ESPSettings.nameESP = not ESPSettings.nameESP
end

return ESP
